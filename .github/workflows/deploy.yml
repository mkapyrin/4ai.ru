name: ğŸš€ Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ”„ Increment version (patch)
      run: npm run version:patch

    - name: ğŸ—ï¸ Build Next.js app
      run: npm run build

    - name: ğŸ“¤ Upload build files
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        source: "out/*"
        target: "/tmp/4ai-ru-nextjs-deploy/"
        strip_components: 1
        timeout: 120s

    - name: ğŸš€ Deploy to server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          echo "ğŸš€ Starting deployment of version $(grep "const siteVersion" src/components/Footer.tsx | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+")"

          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ backup
          echo "ğŸ“‹ Creating backup..."
          BACKUP_DIR="/var/www/4ai.ru.backup-$(date +%Y%m%d-%H%M%S)"
          cp -r /var/www/4ai.ru "$BACKUP_DIR"
          echo "âœ… Backup created: $BACKUP_DIR"

          # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ production Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ
          echo "ğŸ§¹ Cleaning production directory..."
          rm -rf /var/www/4ai.ru/*

          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
          echo "ğŸ“¦ Copying new files..."
          cp -r /tmp/4ai-ru-nextjs-deploy/* /var/www/4ai.ru/

          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ°
          echo "ğŸ” Setting permissions..."
          chown -R www-data:www-data /var/www/4ai.ru
          chmod -R 755 /var/www/4ai.ru

          # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
          echo "ğŸ§¹ Cleaning temp files..."
          rm -rf /tmp/4ai-ru-nextjs-deploy

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼
          echo "âœ… Checking deployment..."
          if curl -f -s https://4ai.ru > /dev/null; then
            echo "âœ… Site is accessible"
            echo "ğŸ‰ Deployment completed successfully!"
            echo "ğŸ“Š Version: $(grep "const siteVersion" /var/www/4ai.ru/*.js | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+" | head -1)"
          else
            echo "âŒ Site is not accessible"
            exit 1
          fi
